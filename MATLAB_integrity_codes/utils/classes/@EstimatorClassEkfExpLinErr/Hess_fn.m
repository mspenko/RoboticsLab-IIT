function Su = Hess_fn(obj,u,dT,params)
option = optimoptions('fmincon','display','off');

ax = u(1);
ay = u(2);
az = u(3);
wy = u(5);
wz = u(6);

%x = [phi, thata, psi, bx_f, by_f, bz_f, by_w, bz_w]

%Hessian optimization
%f1:0, f2:0, f3:0
%f4
hess4 = @(x) -(10^10)*sum(abs(diag(sqrtm(obj.PX./dT)*[zeros(6,15);zeros(6,6),...
    [(ay-x(5))*(cos(x(1))*sin(x(3))-sin(x(1))*sin(x(2))*cos(x(3)))-(az-x(6))*(sin(x(1))*sin(x(3))+cos(x(1))*sin(x(2))*cos(x(3))),(ay-x(5))*cos(x(1))*cos(x(2))*cos(x(3))-(az-x(6))*sin(x(1))*cos(x(2))*cos(x(3)),(ay-x(5))*(sin(x(1))*cos(x(3))-cos(x(1))*sin(x(2))*sin(x(3)))+(az-x(6))*(cos(x(1))*cos(x(3))+sin(x(1))*sin(x(2))*sin(x(3))),0,-(sin(x(1))*sin(x(3))+cos(x(1))*sin(x(2))*cos(x(3))),-(cos(x(1))*sin(x(3))-sin(x(1))*sin(x(2))*cos(x(3)));...
    (ay-x(5))*cos(x(1))*cos(x(2))*cos(x(3))-(az-x(6))*sin(x(1))*cos(x(2))*cos(x(3)),-(ax-x(4))*cos(x(2))*cos(x(3))-(ay-x(5))*sin(x(1))*sin(x(2))*cos(x(3))-(az-x(6))*cos(x(1))*sin(x(2))*cos(x(3)),(ax-x(4))*sin(x(2))*sin(x(3))-(ay-x(5))*sin(x(1))*cos(x(2))*sin(x(3))-(az-x(6))*cos(x(1))*cos(x(2))*sin(x(3)),sin(x(2))*cos(x(3)),-sin(x(1))*cos(x(2))*cos(x(3)),-cos(x(1))*cos(x(2))*cos(x(3));...
    (ay-x(5))*(sin(x(1))*cos(x(3))-cos(x(1))*sin(x(2))*sin(x(3)))+(az-x(6))*(cos(x(1))*cos(x(3))+sin(x(1))*sin(x(2))*sin(x(3))),(ax-x(4))*sin(x(2))*sin(x(3))-(ay-x(5))*sin(x(1))*cos(x(2))*sin(x(3))-(az-x(6))*cos(x(1))*cos(x(2))*sin(x(3)),-(ax-x(4))*cos(x(2))*cos(x(3))-(ay-x(5))*(sin(x(1))*sin(x(2))*cos(x(3))-cos(x(1))*sin(x(3)))-(az-x(6))*(sin(x(1))*sin(x(3))+cos(x(1))*sin(x(2))*cos(x(3))),cos(x(2))*sin(x(3)),sin(x(1))*sin(x(2))*sin(x(3))+cos(x(1))*cos(x(3)),cos(x(1))*sin(x(2))*sin(x(3))-sin(x(1))*cos(x(3));...
    0,sin(x(2))*cos(x(3)),cos(x(2))*sin(x(3)),0,0,0;...
    -(sin(x(1))*sin(x(3))+cos(x(1))*sin(x(2))*cos(x(3))),-sin(x(1))*cos(x(2))*cos(x(3)),sin(x(1))*sin(x(2))*sin(x(3))+cos(x(1))*cos(x(3)),0,0,0;...
    -(cos(x(1))*sin(x(3))-sin(x(1))*sin(x(2))*cos(x(3))),-cos(x(1))*cos(x(2))*cos(x(3)),cos(x(1))*sin(x(2))*sin(x(3))-sin(x(1))*cos(x(3)),0,0,0],...
    zeros(6,3);zeros(3,15)]*sqrtm(obj.PX./dT))));

% f5
hess5 = @(x) -(10^10)*sum(abs(diag(sqrtm(obj.PX./dT)*[zeros(6,15);zeros(6,6),...
        [-(ay-x(5))*(cos(x(1))*cos(x(3))+sin(x(1))*sin(x(2))*sin(x(3)))-(az-x(6))*(cos(x(1))*sin(x(2))*sin(x(3))-sin(x(1))*cos(x(3))),(ay-x(5))*cos(x(1))*cos(x(2))*sin(x(3))-(az-x(6))*sin(x(1))*cos(x(2))*sin(x(3)),(ay-x(5))*(sin(x(1))*sin(x(3))+cos(x(1))*sin(x(2))*cos(x(3)))+(az-x(6))*(cos(x(1))*sin(x(3))-sin(x(1))*sin(x(2))*cos(x(3))),0,sin(x(1))*cos(x(3))-cos(x(1))*sin(x(2))*sin(x(3)),cos(x(1))*cos(x(3))+sin(x(1))*sin(x(2))*sin(x(3));...
        (ay-x(5))*cos(x(1))*cos(x(2))*sin(x(3))-(az-x(6))*sin(x(1))*cos(x(2))*sin(x(3)),-(ax-x(4))*cos(x(2))*sin(x(3))-(ay-x(5))*sin(x(1))*sin(x(2))*sin(x(3))-(az-x(6))*cos(x(1))*sin(x(2))*sin(x(3)),-(ax-x(4))*sin(x(2))*cos(x(3))+(ay-x(5))*sin(x(1))*cos(x(2))*cos(x(3))+(az-x(6))*cos(x(1))*cos(x(2))*cos(x(3)),sin(x(2))*sin(x(3)),-sin(x(1))*cos(x(2))*sin(x(3)),-cos(x(1))*cos(x(2))*sin(x(3));...
        (ay-x(5))*(sin(x(1))*sin(x(3))+cos(x(1))*sin(x(2))*cos(x(3)))+(az-x(6))*(cos(x(1))*sin(x(3))-sin(x(1))*sin(x(2))*cos(x(3))),-(ax-x(4))*sin(x(2))*cos(x(3))+(ay-x(5))*sin(x(1))*cos(x(2))*cos(x(3))+(az-x(6))*cos(x(1))*cos(x(2))*cos(x(3)),-(ax-x(4))*cos(x(2))*sin(x(3))-(ay-x(5))*(sin(x(1))*sin(x(2))*sin(x(3))+cos(x(1))*cos(x(3)))-(az-x(6))*(cos(x(1))*sin(x(2))*sin(x(3))-sin(x(1))*cos(x(3))),-cos(x(2))*cos(x(3)),-(sin(x(1))*sin(x(2))*cos(x(3))-cos(x(1))*sin(x(3))),-(cos(x(1))*sin(x(2))*cos(x(3))+sin(x(1))*sin(x(3)));...
        0,sin(x(2))*sin(x(3)),-cos(x(2))*cos(x(3)),0,0,0;...
        sin(x(1))*cos(x(3))-cos(x(1))*sin(x(2))*sin(x(3)),-sin(x(1))*cos(x(2))*sin(x(3)),-(sin(x(1))*sin(x(2))*cos(x(3))-cos(x(1))*sin(x(3))),0,0,0;...
        cos(x(1))*cos(x(3))+sin(x(1))*sin(x(2))*sin(x(3)),-cos(x(1))*cos(x(2))*sin(x(3)),-(cos(x(1))*sin(x(2))*cos(x(3))+sin(x(1))*sin(x(3))),0,0,0],...
        zeros(6,3);zeros(3,15)]*sqrtm(obj.PX./dT))));

% f6
hess6 = @(x) -(10^10)*sum(abs(diag(sqrtm(obj.PX./dT)*[zeros(6,15);zeros(6,6),...
        [-(ay-x(5))*sin(x(1))*cos(x(2))-(az-x(6))*cos(x(1))*cos(x(2)),-(ay-x(5))*cos(x(1))*sin(x(2))+(az-x(6))*sin(x(1))*sin(x(2)),0,0,-cos(x(1))*cos(x(2)),sin(x(1))*cos(x(2));...
        -(ay-x(5))*cos(x(1))*sin(x(2))+(az-x(6))*sin(x(1))*sin(x(2)),(ax-x(4))*sin(x(2))-(ay-x(5))*sin(x(1))*cos(x(2))-(az-x(6))*cos(x(1))*cos(x(2)),0,cos(x(2)),sin(x(1))*sin(x(2)),cos(x(1))*sin(x(2));...
        0,0,0,0,0,0;...
        0,cos(x(2)),0,0,0,0;...
        -cos(x(1))*cos(x(2)),sin(x(1))*sin(x(2)),0,0,0,0;...
        sin(x(1))*cos(x(2)),cos(x(1))*sin(x(2)),0,0,0,0],...
        zeros(6,3);zeros(3,15)]*sqrtm(obj.PX./dT))));

% f7
hess7 = @(x) -sum(abs(diag(sqrtm(obj.PX./dT)*[zeros(6,15);zeros(2,6),...
        [-(wy-x(7))*sin(x(1))*tan(x(2))-(wz-x(8))*cos(x(1))*tan(x(2)),(wy-x(7))*cos(x(1))/(cos(x(2))^2)-(wz-x(8))*sin(x(1))/(cos(x(2))^2);...
        (wy-x(7))*cos(x(1))/(cos(x(2))^2)-(wz-x(8))*sin(x(1))/(cos(x(2))^2),(wy-x(7))*sin(x(1))*2*sin(x(2))/(cos(x(2))^3)+(wz-x(8))*cos(x(1))*2*sin(x(2))/(cos(x(2))^3)],...
        zeros(2,5),[-cos(x(1))*tan(x(2)),sin(x(1))*tan(x(2));-sin(x(1))/(cos(x(2))^2),-cos(x(1))/(cos(x(2))^2)];...
        zeros(5,15);zeros(2,6),[-cos(x(1))*tan(x(2)),-sin(x(1))/(cos(x(2))^2);sin(x(1))*tan(x(2)),-cos(x(1))/(cos(x(2))^2)],zeros(2,7)]*sqrtm(obj.PX./dT))));

% f8
hess8 = @(x) -(10^10)*sum(abs(diag(sqrtm(obj.PX./dT)*[zeros(6,15);zeros(2,6),...
        [-(wy-x(7))*cos(x(1))+(wz-x(8))*sin(x(1)),0; 0,0],...
        zeros(2,5),[sin(x(1)),cos(x(1)); 0,0];...
        zeros(5,15);zeros(2,6),[sin(x(1)),0; cos(x(1)),0],zeros(2,7)]*sqrtm(obj.PX./dT))));

% f9
hess9 = @(x) -sum(abs(diag(sqrtm(obj.PX./dT)*[zeros(6,15);zeros(2,6),...
        [-(wy-x(7))*sin(x(1))/cos(x(2))-(wz-x(8))*cos(x(1))/cos(x(2)),(wy-x(7))*cos(x(1))*sin(x(2))/(cos(x(2))^2)-(wz-x(8))*sin(x(1))*sin(x(2))/(cos(x(2))^2);...
        (wy-x(7))*cos(x(1))*sin(x(2))/(cos(x(2))^2)-(wz-x(8))*sin(x(1))*sin(x(2))/(cos(x(2))^2),(wy-x(7))*sin(x(1))*(1+(sin(x(2))^2))/(cos(x(2))^3)+(wz-x(8))*cos(x(1))*(1+(sin(x(2))^2))/(cos(x(2))^3)],...
        zeros(2,5),[-cos(x(1))/cos(x(2)),sin(x(1))/cos(x(2));-sin(x(1))*sin(x(2))/(cos(x(2))^2),-cos(x(1))*sin(x(2))/(cos(x(2))^2)];...
        zeros(5,15);zeros(2,6),[-cos(x(1))/cos(x(2)),-sin(x(1))*sin(x(2))/(cos(x(2))^2);sin(x(1))/cos(x(2)),-cos(x(1))*sin(x(2))/(cos(x(2))^2)],zeros(2,7)]*sqrtm(obj.PX./dT))));

% f10:0, f11:0, f12:0, f13:0, f14:0, f15:0

% optimization
option = optimoptions('fmincon','display','off');
%X_min = [pi_to_pi(obj.XX(7)-pi),pi_to_pi(obj.XX(8)-pi),pi_to_pi(obj.XX(9)-pi),icdf('Normal',params.range_req/2,obj.XX(10),sqrt(obj.PX(10,10))),icdf('Normal',params.range_req/2,obj.XX(11),sqrt(obj.PX(11,11))),icdf('Normal',params.range_req/2,obj.XX(12),sqrt(obj.PX(12,12))),icdf('Normal',params.range_req/2,obj.XX(14),sqrt(obj.PX(14,14))),icdf('Normal',params.range_req/2,obj.XX(15),sqrt(obj.PX(15,15)))];
%X_max = [pi_to_pi(obj.XX(7)+pi),pi_to_pi(obj.XX(8)+pi),pi_to_pi(obj.XX(9)+pi),obj.XX(10)+ (obj.XX(10) - X_min(4)),obj.XX(11)+ (obj.XX(11) - X_min(5)),obj.XX(12)+ (obj.XX(12) - X_min(6)),obj.XX(14)+ (obj.XX(14) - X_min(7)),obj.XX(15)+ (obj.XX(15) - X_min(8))];
X_min = [icdf('Normal',params.range_req/2,obj.XX(7),sqrt(obj.PX(7,7))),icdf('Normal',params.range_req/2,obj.XX(8),sqrt(obj.PX(8,8))),icdf('Normal',params.range_req/2,obj.XX(9),sqrt(obj.PX(9,9))),icdf('Normal',params.range_req/2,obj.XX(10),sqrt(obj.PX(10,10))),icdf('Normal',params.range_req/2,obj.XX(11),sqrt(obj.PX(11,11))),icdf('Normal',params.range_req/2,obj.XX(12),sqrt(obj.PX(12,12))),icdf('Normal',params.range_req/2,obj.XX(14),sqrt(obj.PX(14,14))),icdf('Normal',params.range_req/2,obj.XX(15),sqrt(obj.PX(15,15)))];
X_max = [obj.XX(7)+(obj.XX(7) - X_min(1)),obj.XX(8)+(obj.XX(8) - X_min(2)),obj.XX(9)+(obj.XX(9) - X_min(3)),obj.XX(10)+ (obj.XX(10) - X_min(4)),obj.XX(11)+ (obj.XX(11) - X_min(5)),obj.XX(12)+ (obj.XX(12) - X_min(6)),obj.XX(14)+ (obj.XX(14) - X_min(7)),obj.XX(15)+ (obj.XX(15) - X_min(8))];

[~,fval4] = fmincon(hess4,[obj.XX(7),obj.XX(8),obj.XX(9),obj.XX(10),obj.XX(11),obj.XX(12),obj.XX(14),obj.XX(15)],[],[],[],[],X_min,X_max,[],option);
[~,fval5] = fmincon(hess5,[obj.XX(7),obj.XX(8),obj.XX(9),obj.XX(10),obj.XX(11),obj.XX(12),obj.XX(14),obj.XX(15)],[],[],[],[],X_min,X_max,[],option);
[~,fval6] = fmincon(hess6,[obj.XX(7),obj.XX(8),obj.XX(9),obj.XX(10),obj.XX(11),obj.XX(12),obj.XX(14),obj.XX(15)],[],[],[],[],X_min,X_max,[],option);
[~,fval7] = fmincon(hess7,[obj.XX(7),obj.XX(8),obj.XX(9),obj.XX(10),obj.XX(11),obj.XX(12),obj.XX(14),obj.XX(15)],[],[],[],[],X_min,X_max,[],option);
[~,fval8] = fmincon(hess8,[obj.XX(7),obj.XX(8),obj.XX(9),obj.XX(10),obj.XX(11),obj.XX(12),obj.XX(14),obj.XX(15)],[],[],[],[],X_min,X_max,[],option);
[~,fval9] = fmincon(hess9,[obj.XX(7),obj.XX(8),obj.XX(9),obj.XX(10),obj.XX(11),obj.XX(12),obj.XX(14),obj.XX(15)],[],[],[],[],X_min,X_max,[],option);

Su = diag([0,0,0,(fval4/10^10)^2,(fval5/10^10)^2,(fval6/10^10)^2,(fval7)^2,(fval8/10^10)^2,(fval9)^2,0,0,0,0,0,0])*(obj.Dc_cov_state/4);

end
